USE [SUPPORT_AX2012_model]
GO

/****** Object:  UserDefinedFunction [dbo].[SECURITYROLE_FUNC]    Script Date: 24-05-2017 10:15:20 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[SECURITYROLE_FUNC](@LANG NVARCHAR(20))
RETURNS @ROLES TABLE(
      [NAME] NVARCHAR(2048),
      [ALLOWPASTRECORDS] INT,
      [ALLOWCURRENTRECORDS] INT,
      [ALLOWFUTURERECORDS] INT,
      [DESCRIPTION] NVARCHAR(2048),
      [AOTNAME] NVARCHAR(255) COLLATE SQL_Latin1_General_CP1_CI_AS,
      [ISENABLED] INT,
      [CONTEXTSTRING] NVARCHAR(50),
      [RECVERSION] INT,
      [RECID] BIGINT)
AS BEGIN
    INSERT INTO @ROLES
    SELECT
            COALESCE(NAMELABEL.Text, SECROLE.[LABEL]) AS [NAME],
            SECROLE.[ALLOWPAST] AS [ALLOWPASTRECORDS],
            SECROLE.[ALLOWCURRENT] AS [ALLOWCURRENTRECORDS], 
            SECROLE.[ALLOWFUTURE] AS [ALLOWFUTURERECORDS],
            COALESCE(DESCRIPTIONLABEL.Text, SECROLE.[DESCRIPTION]) AS [DESCRIPTION],
            SECROLE.[NAME] COLLATE SQL_Latin1_General_CP1_CI_AS AS [AOTNAME],
            SECROLE.[ISENABLED] AS [ISENABLED],
            SECROLE.[CONTEXTSTRING] AS [CONTEXTSTRING],
            T.ROLELAYER AS [RECVERSION],
            SECROLE.[ROLEHANDLE] AS [RECID]
            FROM [dbo].[ModelSecurityRole] SECROLE
			JOIN (
				SELECT MAXROLE.ROLEHANDLE ROLEHANDLE, MAX(MAXROLE.ROLELAYER) ROLELAYER
				FROM [dbo].[ModelSecurityRole] MAXROLE
				GROUP BY MAXROLE.ROLEHANDLE
			) T ON T.ROLEHANDLE = SECROLE.ROLEHANDLE AND T.ROLELAYER = SECROLE.ROLELAYER
            LEFT JOIN [dbo].ModelElementLabel NAMELABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON NAMELABEL.Module = SECROLE.LABELMODULE AND NAMELABEL.LabelId = SECROLE.LABELID AND NAMELABEL.Language = @LANG
            LEFT JOIN [dbo].ModelElementLabel DESCRIPTIONLABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON DESCRIPTIONLABEL.Module = SECROLE.DESCRIPTIONMODULE AND DESCRIPTIONLABEL.LabelId = SECROLE.DESCRIPTIONID AND DESCRIPTIONLABEL.Language = @LANG
            WHERE SECROLE.UTILTYPE = 133 -- CRT_SECROLE
      RETURN;
END

GO


USE [SUPPORT_AX2012_model]
GO

/****** Object:  UserDefinedFunction [dbo].[SECURITYROLE_INLINEFUNC]    Script Date: 24-05-2017 10:15:47 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[SECURITYROLE_INLINEFUNC](@LANG NVARCHAR(20))
RETURNS TABLE
RETURN SELECT
		COALESCE(NAMELABEL.Text, SECROLE.[LABEL]) AS [NAME],
		SECROLE.[ALLOWPAST] AS [ALLOWPASTRECORDS],
		SECROLE.[ALLOWCURRENT] AS [ALLOWCURRENTRECORDS], 
		SECROLE.[ALLOWFUTURE] AS [ALLOWFUTURERECORDS],
		COALESCE(DESCRIPTIONLABEL.Text, SECROLE.[DESCRIPTION]) AS [DESCRIPTION],
		SECROLE.[NAME] COLLATE SQL_Latin1_General_CP1_CI_AS AS [AOTNAME],
		SECROLE.[ISENABLED] AS [ISENABLED],
		SECROLE.[CONTEXTSTRING] AS [CONTEXTSTRING],
		T.ROLELAYER AS [RECVERSION],
		SECROLE.[ROLEHANDLE] AS [RECID]
		FROM [dbo].[ModelSecurityRole] SECROLE
		JOIN (
			SELECT MAXROLE.ROLEHANDLE ROLEHANDLE, MAX(MAXROLE.ROLELAYER) ROLELAYER
			FROM [dbo].[ModelSecurityRole] MAXROLE
			GROUP BY MAXROLE.ROLEHANDLE
		) T ON T.ROLEHANDLE = SECROLE.ROLEHANDLE AND T.ROLELAYER = SECROLE.ROLELAYER
		LEFT JOIN [dbo].ModelElementLabel NAMELABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON NAMELABEL.Module = SECROLE.LABELMODULE AND NAMELABEL.LabelId = SECROLE.LABELID AND NAMELABEL.Language = @LANG
		LEFT JOIN [dbo].ModelElementLabel DESCRIPTIONLABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON DESCRIPTIONLABEL.Module = SECROLE.DESCRIPTIONMODULE AND DESCRIPTIONLABEL.LabelId = SECROLE.DESCRIPTIONID AND DESCRIPTIONLABEL.Language = @LANG
		WHERE SECROLE.UTILTYPE = 133 -- CRT_SECROLE

GO


USE [SUPPORT_AX2012_model]
GO

/****** Object:  UserDefinedFunction [dbo].[SECURITYTASK_FUNC]    Script Date: 24-05-2017 10:15:59 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[SECURITYTASK_FUNC](@LANG NVARCHAR(20))
RETURNS @ROLES TABLE(
      [NAME] NVARCHAR(2048),
      [AOTNAME] NVARCHAR(255) COLLATE SQL_Latin1_General_CP1_CI_AS,
      [ISPERMISSIONSET] INT,
      [DESCRIPTION] NVARCHAR(2048),
      [TYPE] INT,
      [ISENABLED] INT,
      [RECVERSION] INT,
      [RECID] BIGINT PRIMARY KEY)
AS BEGIN
    INSERT INTO @ROLES 
      SELECT
            COALESCE(NAMELABEL.Text, SECROLE.[LABEL]) AS [NAME],
            SECROLE.[NAME] COLLATE SQL_Latin1_General_CP1_CI_AS AS [AOTNAME],
            0 AS [ISPERMISSIONSET],
            COALESCE(DESCRIPTIONLABEL.Text, SECROLE.[DESCRIPTION]) AS [DESCRIPTION],
            SECROLE.[GUITYPE] AS [TYPE],
            SECROLE.[ISENABLED] AS ISENABLED,
            T.ROLELAYER AS [RECVERSION],
            SECROLE.[ROLEHANDLE] as RECID
            FROM [dbo].[ModelSecurityRole] SECROLE
			JOIN (
				SELECT MAXROLE.ROLEHANDLE ROLEHANDLE, MAX(MAXROLE.ROLELAYER) ROLELAYER
				FROM [dbo].[ModelSecurityRole] MAXROLE
				GROUP BY MAXROLE.ROLEHANDLE
			) T ON T.ROLEHANDLE = SECROLE.ROLEHANDLE AND T.ROLELAYER = SECROLE.ROLELAYER
            LEFT JOIN [dbo].ModelElementLabel NAMELABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON NAMELABEL.Module = SECROLE.LABELMODULE AND NAMELABEL.LabelId = SECROLE.LABELID AND NAMELABEL.Language = @LANG
            LEFT JOIN [dbo].ModelElementLabel DESCRIPTIONLABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON DESCRIPTIONLABEL.Module = SECROLE.DESCRIPTIONMODULE AND DESCRIPTIONLABEL.LabelId = SECROLE.DESCRIPTIONID AND DESCRIPTIONLABEL.Language = @LANG
            WHERE (
            SECROLE.UTILTYPE = 135 --CRT_SECDUTY
            OR SECROLE.UTILTYPE = 134 --CRT_SECPRIVILEGE
            OR SECROLE.UTILTYPE = 136 --CRT_SECPROCESSCYCLE
      )
      RETURN;
END

GO


USE [SUPPORT_AX2012_model]
GO

/****** Object:  UserDefinedFunction [dbo].[SECURITYTASK_INLINEFUNC]    Script Date: 24-05-2017 10:16:11 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[SECURITYTASK_INLINEFUNC](@LANG NVARCHAR(20))
RETURNS TABLE
RETURN SELECT
		COALESCE(NAMELABEL.Text, SECROLE.[LABEL]) AS [NAME],
		SECROLE.[NAME] COLLATE SQL_Latin1_General_CP1_CI_AS AS [AOTNAME],
		0 AS [ISPERMISSIONSET],
		COALESCE(DESCRIPTIONLABEL.Text, SECROLE.[DESCRIPTION]) AS [DESCRIPTION],
		SECROLE.[GUITYPE] AS [TYPE],
		SECROLE.[ISENABLED] AS ISENABLED,
		T.ROLELAYER AS [RECVERSION],
		SECROLE.[ROLEHANDLE] as RECID
	FROM [dbo].[ModelSecurityRole] SECROLE
	JOIN (
		SELECT MAXROLE.ROLEHANDLE ROLEHANDLE, MAX(MAXROLE.ROLELAYER) ROLELAYER
		FROM [dbo].[ModelSecurityRole] MAXROLE
		GROUP BY MAXROLE.ROLEHANDLE
	) T ON T.ROLEHANDLE = SECROLE.ROLEHANDLE AND T.ROLELAYER = SECROLE.ROLELAYER
	LEFT JOIN [dbo].ModelElementLabel NAMELABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON NAMELABEL.Module = SECROLE.LABELMODULE AND NAMELABEL.LabelId = SECROLE.LABELID AND NAMELABEL.Language = @LANG
	LEFT JOIN [dbo].ModelElementLabel DESCRIPTIONLABEL WITH (INDEX(I_ModelElementLabel_ModuleLanId)) ON DESCRIPTIONLABEL.Module = SECROLE.DESCRIPTIONMODULE AND DESCRIPTIONLABEL.LabelId = SECROLE.DESCRIPTIONID AND DESCRIPTIONLABEL.Language = @LANG
	WHERE (
		SECROLE.UTILTYPE = 135 --CRT_SECDUTY
		OR SECROLE.UTILTYPE = 134 --CRT_SECPRIVILEGE
		OR SECROLE.UTILTYPE = 136 --CRT_SECPROCESSCYCLE
	)

GO


